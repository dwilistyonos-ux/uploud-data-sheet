<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cari Data Pelanggan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #4c1d95 0%, #1e1b4b 100%);
      min-height: 100vh;
    }
    .copy-anim:active {
      transform: scale(0.95);
      background-color: #4ade80;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="p-5 font-sans text-slate-100 flex flex-col items-center">

  <div class="max-w-md w-full bg-white rounded-3xl p-6 shadow-2xl mb-8 text-slate-800">
    <h2 class="text-2xl font-black text-center text-indigo-700 mb-5 tracking-tight uppercase">Cari Pelanggan</h2>
    <div class="relative">
      <input type="text" id="userInput" placeholder="Ketik Nama atau ID CST..." 
             class="w-full border-2 border-slate-200 rounded-2xl p-4 mb-4 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all pl-12">
      <span class="absolute left-4 top-4 text-slate-400">üîç</span>
    </div>
    <button onclick="cari()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 rounded-2xl shadow-lg transition-all active:scale-95 uppercase">
      Cek Data
    </button>
    <div id="loader" class="hidden text-center mt-4 text-indigo-600 font-bold animate-pulse">üîé Mencari data...</div>
  </div>

  <div id="resultsList" class="max-w-md w-full space-y-4"></div>

  <script>
    async function cari() {
      const kueri = document.getElementById('userInput').value;
      const list = document.getElementById('resultsList');
      const loader = document.getElementById('loader');
      
      // --- URL WEB APP ANDA DI BAWAH INI ---
      const url = "https://script.google.com/macros/s/AKfycbwGnCfDLY6e6CI_09PV5ItSscoBe3mtvRhXfs54ry-Kq4t4YZL9Vf-1DDvtjGutBQXb/exec";

      if(!kueri) return alert("Masukkan Nama atau ID!");

      list.innerHTML = "";
      loader.classList.remove('hidden');

      try {
        const response = await fetch(`${url}?id=${encodeURIComponent(kueri)}`);
        const result = await response.json();
        loader.classList.add('hidden');

        if (result.status === "success") {
          const items = Array.isArray(result.data) ? result.data : [result];

          items.forEach(item => {
            let num = item.noHp.toString().replace(/\D/g, '');
            if (num.startsWith('0')) num = '62' + num.slice(1);
            if (!num.startsWith('62')) num = '62' + num;

            const tglBersih = item.tanggal.split('T')[0]; 
            const [hari, bulan, tahun] = tglBersih.includes('/') ? tglBersih.split('/') : tglBersih.split('-').reverse();
            const tglPasang = new Date(`${tahun}-${bulan}-${hari}`);
            const tglSekarang = new Date();
            const selisihWaktu = tglSekarang.getTime() - tglPasang.getTime();
            const selisihHari = Math.floor(selisihWaktu / (1000 * 3600 * 24));
            
            const isLama = selisihHari >= 90;
            const labelLama = isLama ? 
              `<span class="bg-amber-100 text-amber-700 text-[9px] px-2 py-1 rounded-md font-bold border border-amber-200 uppercase tracking-tighter">‚ö†Ô∏è Pelanggan 3+ Bulan</span>` 
              : "";

            const card = `
              <div class="bg-white rounded-3xl p-6 shadow-xl text-slate-800 border-l-[12px] border-indigo-500 fade-in">
                <div class="flex justify-between items-start mb-1 gap-2">
                  <h3 class="font-extrabold text-indigo-900 uppercase text-lg leading-tight truncate">${item.nama}</h3>
                  <div class="flex flex-col items-end gap-1">
                    <span class="text-[9px] bg-indigo-600 text-white px-2 py-0.5 rounded-full font-black uppercase">${item.paket}</span>
                    ${labelLama}
                  </div>
                </div>
                
                <div class="flex items-center gap-2 mb-4">
                  <div onclick="copyToClipboard('${item.idCst}')" 
                       class="flex items-center bg-slate-50 hover:bg-green-50 border border-slate-200 px-3 py-1 rounded-lg cursor-pointer transition-all copy-anim shadow-sm">
                    <span class="text-xs font-mono font-bold text-slate-600 tracking-wider">${item.idCst}</span>
                    <span class="text-[10px] ml-2 text-indigo-500 font-bold italic">üìã SALIN</span>
                  </div>
                  <span class="text-[11px] text-slate-400 truncate max-w-[120px]">${item.email || '-'}</span>
                </div>

                <div class="space-y-2 text-sm bg-slate-50 p-4 rounded-2xl border border-slate-100 mb-4">
                  <div class="flex justify-between border-b border-slate-200 pb-2">
                    <span class="text-slate-500 font-medium">Tanggal Pasang:</span> 
                    <span class="font-bold text-slate-800">${tglBersih}</span>
                  </div>
                  <div class="flex justify-between border-b border-slate-200 pb-2">
                    <span class="text-slate-500 font-medium">Jatuh Tempo:</span> 
                    <span class="font-extrabold text-red-500">Tgl ${item.japo}</span>
                  </div>
                  <div class="flex flex-col pt-1">
                    <span class="text-slate-400 text-[10px] uppercase font-bold tracking-widest">Keterangan Alamat:</span>
                    <span class="text-slate-700 mt-1 italic text-xs leading-relaxed font-semibold">${item.alamat || "Tidak ada keterangan"}</span>
                  </div>
                </div>

                <a href="https://wa.me/${num}" target="_blank" 
                   class="flex items-center justify-center gap-2 w-full bg-green-500 hover:bg-green-600 text-white font-black py-3 rounded-2xl transition-all shadow-md">
                  <span>HUBUNGI WHATSAPP</span> üì±
                </a>
              </div>
            `;
            list.innerHTML += card;
          });
        } else {
          alert("Data tidak ditemukan!");
        }
      } catch (e) {
        loader.classList.add('hidden');
        alert("Gagal memuat data. Periksa koneksi Anda.");
      }
    }

    function copyToClipboard(text) {
      if (!text || text === "-") return;
      navigator.clipboard.writeText(text).then(() => {
        // Berhasil disalin
      }).catch(err => {
        const input = document.createElement('input');
        input.value = text;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
      });
    }
  </script>
</body>
</html>
